with combine_asset as (
  SELECT *,
  EXTRACT(HOUR FROM Datetime) AS houroftheday,
  EXTRACT(MONTH FROM Datetime) AS month,
  EXTRACT(DAY FROM Datetime) AS day,
  GREATEST(Active_power_MWh, 0) AS Active_power_MWh_filled,
  turbine_ID
  FROM flex-power.playground_sales.df_combined
),

combine_asset_sum as (
  SELECT Datetime, houroftheday,
  month,
  day,
  SUM (Active_power_MWh_filled) as ACTIVE_POWER_SUM
  from combine_asset
  GROUP BY Datetime, day, month, houroftheday
),

DAprice as (
  SELECT *,
  EXTRACT(HOUR FROM hour) AS houroftheday,
  EXTRACT(MONTH FROM hour) AS month,
  EXTRACT(DAY FROM hour) AS day

FROM flex-power.playground_sales.Dayaheadprice
WHERE hour >= '2024-01-01' AND hour < '2025-01-01'
),

RMVprice as (
  SELECT *
  FROM flex-power.playground_sales.df_RMV
),


fulldata_temp as (
SELECT
  t.Datetime,
  t.ACTIVE_POWER_SUM,
  t.houroftheday,
  t.day,
  t.month,               -- use t.month instead of p.month
  p.dayaheadprice
FROM combine_asset_sum t
LEFT JOIN DAprice p
ON t.day = p.day AND t.month = p.month AND t.houroftheday = p.houroftheday
),


fulldata AS (
  SELECT
    a.Datetime,
    a.ACTIVE_POWER_SUM,
    a.houroftheday,
    a.day,
    a.month,
    a.dayaheadprice,
    r.RMV_2024_EURMWh
  FROM fulldata_temp a
  LEFT JOIN RMVprice r
    ON a.month = r.month
),


spot_payout as (
SELECT
  Datetime,
  houroftheday,
  day,
  month,
  ACTIVE_POWER_SUM,
  dayaheadprice,
  RMV_2024_EURMWh,
  (ACTIVE_POWER_SUM * dayaheadprice) AS PayOut_HourlySpot,
  (RMV_2024_EURMWh * ACTIVE_POWER_SUM) AS Payout_RMV,
  FROM fulldata
  WHERE Datetime >= '2019-01-01' AND Datetime < '2020-01-01'
),

spot_payout_group AS (
  SELECT 
    month,
    SUM(PayOut_HourlySpot) AS total_spot_payout,
    SUM(Payout_RMV) AS total_rmv_payout
  FROM spot_payout
  GROUP BY month
)

SELECT 
  month,
  SUM(total_spot_payout) AS total_spot_payout,
  SUM(total_rmv_payout) AS total_rmv_payout
FROM spot_payout_group
GROUP BY GROUPING SETS ((month), ())
ORDER BY month


 /* 
SELECT * FROM spot_payout
ORDER BY Datetime
*/
